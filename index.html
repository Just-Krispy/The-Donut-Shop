<script>
    // ... (previous code)

    function handleUserResponse(response) {
        if (!userState) {
            if (response.toLowerCase() === 'existing') {
                userState = 'existing';
                appendMessage("Please enter your name:", true);
            } else if (response.toLowerCase() === 'new') {
                userState = 'new';
                appendMessage("Please enter your name:", true);
            } else {
                appendMessage("Invalid choice. Please enter 'existing' or 'new'.", true);
            }
        } else if (userState === 'new') {
            // New order logic
            if (!customerName) {
                customerName = response;
                appendMessage("Please enter your email address:", true);
            } else if (!customerEmail) {
                customerEmail = response;
                appendMessage("Please enter your contact number:", true);
            } else if (!contactNumber) {
                contactNumber = response;
                appendMessage("Do you want to opt in to receive messages for orders and updates? (Y/N):", true);
            } else if (typeof optIn !== 'boolean') {
                if (response.toLowerCase() === 'y') {
                    optIn = true;
                    appendMessage("Please specify the type of donut you want or type 'done' to complete your order:", true);
                } else if (response.toLowerCase() === 'n') {
                    optIn = false;
                    appendMessage("Please specify the type of donut you want or type 'done' to complete your order:", true);
                } else {
                    appendMessage("Invalid choice. Please enter 'Y' or 'N'.", true);
                }
            } else if (!donutType) {
                if (response.toLowerCase() === 'done') {
                    appendMessage(`Dough: Thank you for stopping by Krispy's Donut Shop!`, true);
                    userInput.style.display = 'none'; // Hide the input field
                } else {
                    donutType = response;
                    appendMessage("How many donuts would you like to order?", true);
                }
            } else if (!donutQuantity) {
                donutQuantity = response;
                appendMessage(`Dough: Thank you for waiting, ${customerName}. I am checking the order status for you.`);
                const orderStatus = "In Progress"; // You can change this to "Delayed" or "Shipped"
                appendMessage(`Dough: Your order status is: ${orderStatus}`);
                appendMessage(`Dough: You have ordered ${donutQuantity} ${donutType} donut(s).`);
                appendMessage(`Dough: We will send order updates to ${customerEmail}.`);
                if (optIn) {
                    appendMessage(`Dough: We will also send updates to ${contactNumber}.`);
                } else {
                    appendMessage(`Dough: You have opted out of receiving messages at ${contactNumber}.`);
                }
                appendMessage("Dough: Thank you for stopping by Krispy's Donut Shop!");
            }
        }
    }

    // ... (rest of the code)
</script>
